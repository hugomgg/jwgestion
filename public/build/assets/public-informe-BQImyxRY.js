$(document).ready(function(){const e=window.publicInformeConfig;$.ajaxSetup({headers:{"X-CSRF-TOKEN":e.csrfToken}});const o=[1,3];function a(e,o="info"){const a=$(`\n            <div class="alert alert-${"error"===o?"danger":o} alert-dismissible fade show" role="alert">\n                <i class="fas fa-${"error"===o?"exclamation-triangle":"success"===o?"check-circle":"info-circle"} me-2"></i>\n                <strong>${e}</strong>\n                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>\n            </div>\n        `);$("#alert-container").html(a),$("html, body").animate({scrollTop:0},300),setTimeout(function(){a.fadeOut("slow",function(){$(this).remove()})},8e3)}function r(){$(".is-invalid").removeClass("is-invalid"),$(".invalid-feedback").text("")}function n(){const e=$("#grupo_id").val(),a=$("#user_id").val(),r=$("#periodo").val(),n=$("#servicio_id").val(),i=$("#participa").is(":checked"),t=$("#horas").val(),s=$("#cantidad_estudios").val();let c=e&&a&&r&&n;if(i){const e=parseInt(n);o.includes(e)&&(c=c&&t>0&&t<=100&&t)}c=c&&s>=0&&s<=50&&s,$("#submitBtn").prop("disabled",!c),c?$("#submitBtnHint").fadeOut():$("#submitBtnHint").fadeIn()}function i(){r();const o=$("#submitBtn"),n=o.html();o.prop("disabled",!0),o.html('<span class="spinner-border spinner-border-sm me-2" role="status"></span>Enviando...');const i={grupo_id:$("#grupo_id").val(),user_id:$("#user_id").val(),periodo:$("#periodo").val(),participa:$("#participa").is(":checked")?1:0,servicio_id:$("#servicio_id").val()||null,cantidad_estudios:$("#cantidad_estudios").val()||0,horas:$("#horas").val()||null,comentario:$("#comentario").val()||null};e.recaptchaEnabled&&(i["g-recaptcha-response"]=$("#g-recaptcha-response-informe").val()),$.ajax({url:e.storeUrl,method:"POST",data:i,dataType:"json",success:function(e){e.success?(a("¡Informe enviado exitosamente! Gracias por su colaboración.","success"),$("#informeForm")[0].reset(),$("#cantidad_estudios").prop("disabled",!0),$("#horas").prop("disabled",!0),$("#user_id").html('<option value="">Seleccione primero un grupo...</option>').prop("disabled",!0),$("#submitBtn").prop("disabled",!0),$("html, body").animate({scrollTop:0},300)):a(e.message||"Error al enviar el informe","error")},error:function(e){var o,n;if(422===e.status){!function(e){r(),$.each(e,function(e,o){const a=$(`[name="${e}"]`);a.addClass("is-invalid"),a.siblings(".invalid-feedback").text(o[0])})}(e.responseJSON.errors),a((null==(o=e.responseJSON)?void 0:o.message)||"Por favor, corrija los errores en el formulario","error")}else{a((null==(n=e.responseJSON)?void 0:n.message)||"Error al enviar el informe. Por favor, intente nuevamente.","error")}},complete:function(){o.prop("disabled",!1),o.html(n),e.recaptchaEnabled&&"undefined"!=typeof grecaptcha&&grecaptcha.ready(function(){grecaptcha.execute(e.recaptchaSiteKey,{action:"informe_submit"}).then(function(e){$("#g-recaptcha-response-informe").val(e)})})}})}$("#grupo_id").on("change",function(){const o=$(this).val(),r=$("#user_id");if(r.html('<option value="">Cargando usuarios...</option>'),r.prop("disabled",!0),!o)return r.html('<option value="">Seleccione primero un grupo...</option>'),void n();$.ajax({url:e.getUsersByGrupoUrl,method:"GET",data:{grupo_id:o},success:function(e){if(e.success&&e.usuarios.length>0){let o='<option value="">Seleccione un usuario...</option>';e.usuarios.forEach(function(e){o+=`<option value="${e.id}">${e.name}</option>`}),r.html(o),r.prop("disabled",!1)}else r.html('<option value="">No hay usuarios en este grupo</option>'),a("No se encontraron usuarios activos en el grupo seleccionado","warning");n()},error:function(){r.html('<option value="">Error al cargar usuarios</option>'),a("Error al cargar los usuarios del grupo","error"),n()}})}),$("#participa").on("change",function(){const e=$(this).is(":checked"),a=parseInt($("#servicio_id").val()),r=$("#horas"),i=$("#horas_container"),t=$("#cantidad_estudios_container"),s=$("#cantidad_estudios");e?(t.slideDown(300),s.prop("disabled",!1),o.includes(a)&&(i.slideDown(300),r.prop("disabled",!1),r.attr("required",!0))):(t.slideUp(300),s.val("0").prop("disabled",!0),i.slideUp(300),r.val("").prop("disabled",!0),r.attr("required",!1)),n()}),$("#cantidad_estudios").on("input change",function(){n()}),$("#servicio_id").on("change",function(){const e=$("#participa").is(":checked"),a=parseInt($(this).val()),r=$("#horas"),i=$("#horas_container");e&&(o.includes(a)?(i.slideDown(300),r.prop("disabled",!1),r.attr("required",!0)):(i.slideUp(300),r.val(""),r.prop("disabled",!0),r.attr("required",!1))),n()}),$("#informeForm").on("submit",function(o){o.preventDefault();const r=$("#participa").is(":checked"),n=$("#comentario").val().trim();r||""!==n?e.recaptchaEnabled&&"undefined"!=typeof grecaptcha?grecaptcha.ready(function(){grecaptcha.execute(e.recaptchaSiteKey,{action:"informe_submit"}).then(function(e){$("#g-recaptcha-response-informe").val(e),i()}).catch(function(e){console.error("Error al obtener token de reCAPTCHA:",e),a("Error de verificación de seguridad. Por favor, recargue la página e intente nuevamente.","error")})}):i():a("Por favor, complete al menos un campo (Comentario o Participación)","error")}),$("select[required], input[required]").on("change blur",function(){const e=$(this);e.val()&&(e.removeClass("is-invalid"),e.siblings(".invalid-feedback").text("")),n()}),$("#user_id, #periodo").on("change",function(){n()}),$("#horas").on("input change",function(){n()}),$("#comentario").on("input",function(){const e=$(this).val().length,o=1e3-e;let a=`${e} / 1000 caracteres`;o<100&&(a=`<span class="text-warning">${a} (${o} restantes)</span>`);let r=$(this).siblings(".char-counter");0===r.length&&(r=$('<small class="form-text text-muted char-counter"></small>'),$(this).after(r)),r.html(a)}),$(".form-control, .form-select").on("focus",function(){$(this).closest(".mb-4").addClass("focused")}).on("blur",function(){$(this).closest(".mb-4").removeClass("focused")}),$("#submitBtn").prop("disabled",!0),n(),e.recaptchaEnabled&&"undefined"!=typeof grecaptcha&&grecaptcha.ready(function(){grecaptcha.execute(e.recaptchaSiteKey,{action:"informe_submit"}).then(function(e){$("#g-recaptcha-response-informe").val(e)}).catch(function(e){console.error("Error al inicializar reCAPTCHA:",e)})})});
