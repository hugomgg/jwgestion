$(document).ready(function(){function e(e,n){const a=$(n),o=a.val();a.data("all-options")||a.data("all-options",a.find("option").clone()),a.empty(),a.append('<option value="">Seleccionar grupo...</option>');a.data("all-options").each(function(){const n=$(this),o=n.data("congregacion-id");""===n.val()||""!==e&&o!=e||a.append(n.clone())}),o&&a.find(`option[value="${o}"]`).length>0?a.val(o):a.val("")}$("#addUserModal").on("shown.bs.modal",function(){i("add"),o(),$("#asignaciones").hasClass("select2-hidden-accessible")&&$("#asignaciones").select2("destroy"),$("#asignaciones").select2({theme:"bootstrap-5",placeholder:"Selecciona asignaciones...",allowClear:!0,width:"100%",dropdownParent:$("#addUserModal"),language:{noResults:function(){return"No se encontraron resultados"},searching:function(){return"Buscando..."}}}),window.usersIndexConfig.userCongregacion&&$("#congregacion").val(window.usersIndexConfig.userCongregacion)}),$("#editUserModal").on("shown.bs.modal",function(){i("edit"),o(),$("#edit_asignaciones").hasClass("select2-hidden-accessible")&&$("#edit_asignaciones").select2("destroy"),$("#edit_asignaciones").select2({theme:"bootstrap-5",placeholder:"Selecciona asignaciones...",allowClear:!0,width:"100%",dropdownParent:$("#editUserModal"),language:{noResults:function(){return"No se encontraron resultados"},searching:function(){return"Buscando..."}}})}),$("#addUserModal").on("hidden.bs.modal",function(){i("add"),o(),$("#asignaciones").hasClass("select2-hidden-accessible")&&$("#asignaciones").select2("destroy")}),$("#editUserModal").on("hidden.bs.modal",function(){i("edit"),o(),$("#edit_asignaciones").hasClass("select2-hidden-accessible")&&$("#edit_asignaciones").select2("destroy")}),$("#congregacion").on("change",function(){e($(this).val(),"#grupo")}),$("#edit_congregacion").on("change",function(){e($(this).val(),"#edit_grupo")});var n=$("#usersTable").DataTable({responsive:!0,language:{url:"/js/datatables-es-ES.json"},pageLength:10,lengthMenu:[[10,25,50,100],[10,25,50,100]],dom:'<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rtip',columnDefs:window.usersIndexConfig.datatablesColumnDefs});function a(e,n){const a=`\n            <div class="alert alert-${e} alert-dismissible fade show" role="alert">\n                ${n}\n                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>\n            </div>\n        `;$("#alert-container").html(a),"success"===e&&setTimeout(()=>{$(".alert").alert("close")},5e3)}function o(){$(".form-control, .form-select").removeClass("is-invalid"),$(".invalid-feedback").text("")}function s(e,n="add"){o();const a="edit"===n?"editUserErrorList":"addUserErrorList",s=$("#"+("edit"===n?"editUserErrorContainer":"addUserErrorContainer")),i=$("#"+a);i.empty();let t=!1;if($.each(e,function(e,n){t=!0,Array.isArray(n)?n.forEach(function(e){i.append(`<li>${e}</li>`)}):i.append(`<li>${n}</li>`);const a=$(`[name="${e}"]`);a.addClass("is-invalid"),a.siblings(".invalid-feedback").text(Array.isArray(n)?n[0]:n)}),t){s.removeClass("d-none");const e=s.closest(".modal-body");e.length&&e.animate({scrollTop:0},300)}else s.addClass("d-none")}function i(e="add"){const n="edit"===e?"editUserErrorList":"addUserErrorList",a=$("#"+("edit"===e?"editUserErrorContainer":"addUserErrorContainer")),o=$("#"+n);a.addClass("d-none"),o.empty()}function t(e,n="add"){const a=$("#"+e).find("[required]"),o={};let i=!0;return a.each(function(){const e=$(this),n=e.attr("name"),a=e.val(),s=e.prev("label").text().replace("*","").trim();a&&""!==a.trim()||(i=!1,o[n]=[`El campo ${s} es obligatorio.`])}),i||s(o,n),i}$("#congregacionFilter").on("change",function(){const e=$(this).val();""===e?n.column(3).search("").draw():n.column(3).search(e).draw()}),$("#grupoFilter").on("change",function(){const e=$(this).val(),a=window.usersIndexConfig.isLimitedUser?4:3;""===e?n.column(a).search("").draw():n.column(a).search(e).draw()}),$("#nombramientoFilter").on("change",function(){const e=$(this).val(),a=window.usersIndexConfig.isLimitedUser?5:4;""===e?n.column(a).search("").draw():n.column(a).search(e).draw()}),$("#servicioFilter").on("change",function(){const e=$(this).val(),a=window.usersIndexConfig.isLimitedUser?6:5;""===e?n.column(a).search("").draw():n.column(a).search(e).draw()}),$("#perfilFilter").on("change",function(){const e=$(this).val();""===e?n.column(2).search("").draw():"todos-publicadores"===e?n.column(2).search("^(?!.*Estudiante).*$",!0,!1).draw():n.column(2).search(e).draw()});let r=null;if($("#estadoEspiritualFilter").on("change",function(){const e=$(this).val();if(null!==r&&$.fn.dataTable.ext.search.pop(),e){r=e;const n=window.usersIndexConfig.isLimitedUser?7:6;$.fn.dataTable.ext.search.push(function(a,o,s){return o[n].includes(e)})}else r=null;n.draw()}),window.usersIndexConfig.showAsignacionFilter){let e=null;$("#asignacionFilter").on("change",function(){const a=$(this).val();if(null!==e&&$.fn.dataTable.ext.search.splice($.fn.dataTable.ext.search.indexOf(e),1),""===a)e=null,n.draw();else{const o=7;e=function(e,s,i){if(e.nTable!==n.table().node())return!0;return s[o].includes(a)},$.fn.dataTable.ext.search.push(e),n.draw()}})}let d=null;function c(e){if(null!==d&&$.fn.dataTable.ext.search.splice($.fn.dataTable.ext.search.indexOf(d),1),""===e)d=null,n.draw();else{const a="1"===e?"Habilitado":"Deshabilitado",o=window.usersIndexConfig.estadoColumnIndex;d=function(e,s,i){if(e.nTable!==n.table().node())return!0;return-1!==s[o].indexOf(a)},$.fn.dataTable.ext.search.push(d),n.draw()}}function l(e,n){const a=window.usersIndexConfig,o=a.isLimitedUser,s=a.showAsignacionFilter,i=a.canModify,t=o;let r="";n&&n.length>0?n.forEach(function(e){r+=`<span class="badge bg-info me-1">${e.abreviacion}</span>`}):r='<span class="text-muted">-</span>';let d=`\n            <tr data-user-id="${e.id}">\n                <td>${e.id}</td>\n                <td>${e.name}</td>\n                <td><span class="badge bg-info">${e.privilegio_perfil}</span></td>\n        `;t&&(d+=`<td><span class="badge bg-secondary">${e.nombre_congregacion}</span></td>`),d+=`\n                <td><span class="badge bg-dark">${e.nombre_grupo}</span></td>\n                <td>${e.nombre_nombramiento?'<span class="badge bg-primary">'+e.nombre_nombramiento+"</span>":'<span class="text-muted">-</span>'}</td>\n                <td>${e.nombre_servicio?'<span class="badge bg-warning text-dark">'+e.nombre_servicio+"</span>":'<span class="text-muted">-</span>'}</td>\n                <td><span class="badge bg-light text-dark">${e.nombre_estado_espiritual}</span></td>\n        `,s&&(d+=`<td>${r}</td>`);return d+=`\n                <td>${1==e.estado?'<span class="badge bg-success">Habilitado</span>':'<span class="badge bg-danger">Deshabilitado</span>'}</td>\n                <td>\n                    <div class="btn-group" role="group">\n                        <button type="button" class="btn btn-sm btn-info view-user"\n                                data-user-id="${e.id}"\n                                data-bs-toggle="tooltip"\n                                title="Ver usuario">\n                            <i class="fas fa-eye"></i>\n                        </button>\n        `,i&&(d+=`\n                        <button type="button" class="btn btn-sm btn-warning edit-user"\n                                data-user-id="${e.id}"\n                                data-bs-toggle="tooltip"\n                                title="Editar usuario">\n                            <i class="fas fa-edit"></i>\n                        </button>\n            `),d+="\n                    </div>\n                </td>\n            </tr>\n        ",d}$("#estadoFilter").on("change",function(){c($(this).val())}),$("#estadoFilter").val("1"),c("1"),$(document).on("click",".view-user",function(){const e=$(this).data("user-id");$.ajax({url:`/usuarios/${e}/edit`,method:"GET",success:function(e){if(e.success){const n=e.user;$("#view_name").text(n.name||"-"),$("#view_nombre_completo").text(n.nombre_completo||"-"),$("#view_email").text(n.email||"-"),function(e){window.usersIndexConfig.congregaciones&&window.usersIndexConfig.congregaciones.forEach(function(n){n.id==e.congregacion&&$("#view_congregacion").text(n.nombre)});window.usersIndexConfig.perfiles&&window.usersIndexConfig.perfiles.forEach(function(n){n.id==e.perfil&&$("#view_perfil").text(n.privilegio)});window.usersIndexConfig.sexos&&window.usersIndexConfig.sexos.forEach(function(n){n.id==e.sexo&&$("#view_sexo").text(n.nombre)});let n=!1;window.usersIndexConfig.servicios&&window.usersIndexConfig.servicios.forEach(function(a){a.id==e.servicio&&($("#view_servicio").text(a.nombre),n=!0)});n||$("#view_servicio").text("-");window.usersIndexConfig.nombramientos&&window.usersIndexConfig.nombramientos.forEach(function(n){n.id==e.nombramiento&&$("#view_nombramiento").text(n.nombre)});window.usersIndexConfig.esperanzas&&window.usersIndexConfig.esperanzas.forEach(function(n){n.id==e.esperanza&&$("#view_esperanza").text(n.nombre)});window.usersIndexConfig.grupos&&window.usersIndexConfig.grupos.forEach(function(n){n.id==e.grupo_id&&$("#view_grupo").text(n.nombre)});window.usersIndexConfig.estadosEspirituales&&window.usersIndexConfig.estadosEspirituales.forEach(function(n){n.id==e.estado_espiritual&&$("#view_estado_espiritual").text(n.nombre)});if($("#view_fecha_nacimiento").text(e.fecha_nacimiento||"-"),$("#view_fecha_bautismo").text(e.fecha_bautismo||"-"),$("#view_telefono").text(e.telefono||"-"),$("#view_persona_contacto").text(e.persona_contacto||"-"),$("#view_telefono_contacto").text(e.telefono_contacto||"-"),$("#view_observacion").text(e.observacion||"-"),$("#view_estado").html(1==e.estado?'<span class="badge bg-success">Habilitado</span>':'<span class="badge bg-danger">Deshabilitado</span>'),e.asignaciones&&Array.isArray(e.asignaciones)&&e.asignaciones.length>0){let n="";e.asignaciones.forEach(function(e){window.usersIndexConfig.asignaciones&&window.usersIndexConfig.asignaciones.forEach(function(a){a.id==e&&(n+='<span class="badge bg-info me-1 mb-1">'+a.nombre+"</span>")})}),$("#view_asignaciones").html(n||"-")}else $("#view_asignaciones").text("-")}(n),$("#view_creado_por").text(n.creado_por_nombre?`${n.creado_por_nombre} - ${n.creado_por_timestamp}`:"-"),$("#view_modificado_por").text(n.modificado_por_nombre?`${n.modificado_por_nombre} - ${n.modificado_por_timestamp}`:"-"),$("#viewUserModal").modal("show")}else a("danger",e.message||"Error al cargar los datos del usuario.")},error:function(e){const n=e.responseJSON;a("danger",(null==n?void 0:n.message)||"Error al cargar los datos del usuario.")}})}),$("#addUserModal").on("hidden.bs.modal",function(){$("#addUserForm")[0].reset(),o(),$("#saveUserBtn .spinner-border").addClass("d-none"),$("#saveUserBtn").prop("disabled",!1),$("#asignaciones").hasClass("select2-hidden-accessible")&&$("#asignaciones").val([]).trigger("change"),window.usersIndexConfig.userCongregacion&&setTimeout(function(){$("#congregacion").val(window.usersIndexConfig.userCongregacion)},100)}),$("#addUserForm").on("submit",function(e){e.preventDefault();const r=$(this),d=$("#saveUserBtn"),c=d.find(".spinner-border");if(o(),i("add"),!t("addUserForm","add"))return!1;d.prop("disabled",!0),c.removeClass("d-none"),$.ajax({url:window.usersIndexConfig.storeRoute,method:"POST",data:r.serialize(),success:function(e){if(e.success){$("#addUserModal").modal("hide"),a("success",e.message);const o=l(e.user,e.asignaciones);n.row.add($(o)).draw(!1),$('[data-bs-toggle="tooltip"]').tooltip()}},error:function(e){const n=e.responseJSON;if(422===e.status&&n.errors)s(n.errors,"add");else{s({general:[n.message||"Error al crear el usuario. Intente nuevamente."]},"add")}},complete:function(){d.prop("disabled",!1),c.addClass("d-none")}})}),$('[data-bs-toggle="tooltip"]').tooltip(),$(document).on("click",".edit-user",function(){const e=$(this).data("user-id");$("#editUserForm")[0].reset(),o(),i("edit"),$.ajax({url:`/usuarios/${e}/edit`,method:"GET",success:function(e){if(e.success){const n=e.user;if($("#edit_user_id").val(n.id),$("#edit_name").val(n.name),$("#edit_nombre_completo").val(n.nombre_completo),$("#edit_email").val(n.email),$("#edit_perfil").val(n.perfil),$("#edit_estado").val(n.estado),$("#edit_congregacion").val(n.congregacion),n.fecha_nacimiento){let e=n.fecha_nacimiento.split(" ")[0];$("#edit_fecha_nacimiento").val(e)}else $("#edit_fecha_nacimiento").val("");if(n.fecha_bautismo){let e=n.fecha_bautismo.split(" ")[0];$("#edit_fecha_bautismo").val(e)}else $("#edit_fecha_bautismo").val("");$("#edit_telefono").val(n.telefono),$("#edit_persona_contacto").val(n.persona_contacto),$("#edit_telefono_contacto").val(n.telefono_contacto),$("#edit_sexo").val(n.sexo),$("#edit_servicio").val(n.servicio),$("#edit_nombramiento").val(n.nombramiento),$("#edit_esperanza").val(n.esperanza),$("#edit_grupo").val(n.grupo_id),$("#edit_estado_espiritual").val(n.estado_espiritual),$("#edit_observacion").val(n.observacion),n.asignaciones&&Array.isArray(n.asignaciones)?$("#edit_asignaciones").val(n.asignaciones).trigger("change"):$("#edit_asignaciones").val([]).trigger("change"),$("#editUserModal").modal("show")}else a("danger",e.message||"Error al cargar los datos del usuario.")},error:function(e){const n=e.responseJSON;a("danger",(null==n?void 0:n.message)||"Error al cargar los datos del usuario.")}})}),$("#editUserModal").on("hidden.bs.modal",function(){$("#editUserForm")[0].reset(),o(),$("#updateUserBtn .spinner-border").addClass("d-none"),$("#updateUserBtn").prop("disabled",!1),$("#edit_asignaciones").hasClass("select2-hidden-accessible")&&$("#edit_asignaciones").val([]).trigger("change")}),$("#editUserForm").on("submit",function(e){e.preventDefault();const r=$(this),d=$("#edit_user_id").val(),c=$("#updateUserBtn"),u=c.find(".spinner-border");if(o(),i("edit"),!t("editUserForm","edit"))return!1;c.prop("disabled",!0),u.removeClass("d-none"),$.ajax({url:`/usuarios/${d}`,method:"PUT",data:r.serialize(),success:function(e){if(e.success){$("#editUserModal").modal("hide"),a("success",e.message);const o=$(`tr[data-user-id="${d}"]`);if(o.length>0){const a=n.row(o),s=l(e.user,e.asignaciones),i=$(s);o.html(i.html()),a.invalidate(),n.draw(!1),$('[data-bs-toggle="tooltip"]').tooltip()}}},error:function(e){const n=e.responseJSON;if(422===e.status&&n.errors)s(n.errors,"edit");else{s({general:[n.message||"Error al actualizar el usuario. Intente nuevamente."]},"edit")}},complete:function(){c.prop("disabled",!1),u.addClass("d-none")}})}),$("#exportPdfBtn").on("click",function(e){e.preventDefault();const n={congregacion:$("#congregacionFilter").val(),grupo:$("#grupoFilter").val(),nombramiento:$("#nombramientoFilter").val(),servicio:$("#servicioFilter").val(),estadoEspiritual:$("#estadoEspiritualFilter").val(),perfil:$("#perfilFilter").val(),estado:$("#estadoFilter").val(),asignacion:$("#asignacionFilter").val()},a=new URLSearchParams;Object.keys(n).forEach(e=>{n[e]&&a.append(e,n[e])});const o=`${window.usersIndexConfig.exportPdfRoute}?${a.toString()}`;window.location.href=o})});
