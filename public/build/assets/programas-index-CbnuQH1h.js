function e(){const e=$("#filtro_anio").val(),a=$('#mesDropdownMenu input[type="checkbox"]:checked').map(function(){return $(this).val()}).get();let o=window.programasTable;!o&&$.fn.DataTable.isDataTable("#programasTable")&&(o=$("#programasTable").DataTable()),o&&($.fn.dataTable.ext.search.pop(),e&&$.fn.dataTable.ext.search.push(function(o,n,r){const t=n[0].split("/");if(3===t.length){t[0];const o=t[1].padStart(2,"0"),n=t[2];if(e&&n!==e)return!1;if(a.length>0&&!a.includes(o))return!1}return!0}),o.draw())}function a(e,a){const o=`\n        <div class="alert alert-${a} alert-dismissible fade show" role="alert">\n            ${e}\n            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>\n        </div>\n    `;$("#alert-container").html(o),setTimeout(function(){$(".alert").fadeOut()},5e3)}function o(){const e=$("#mesDropdownBtn"),a=$('#mesDropdownMenu input[type="checkbox"]:checked');if(0===a.length)e.text("Seleccionar meses");else if(1===a.length){const o=a.closest("li").find("label").text().trim();e.text(o)}else e.text(`${a.length} meses seleccionados`);window.actualizarBotonesExportacion&&window.actualizarBotonesExportacion()}$(document).ready(function(){if(!$('meta[name="csrf-token"]').attr("content"))return void console.error("CSRF token not found. Make sure the meta tag is present in the HTML.");const n=$("#programasTable").DataTable({language:{url:"/js/datatables-es-ES.json"},responsive:!0,order:[[0,"desc"]],columnDefs:[{targets:[7],orderable:!1}]});function r(){$("#add_presidencia").select2({theme:"bootstrap-5",dropdownParent:$("#addProgramaModal"),placeholder:"Seleccionar presidencia...",allowClear:!0,width:"100%"}),$("#add_orador_inicial").select2({theme:"bootstrap-5",dropdownParent:$("#addProgramaModal"),placeholder:"Seleccionar orador inicial...",allowClear:!0,width:"100%"}),$("#add_orador_final").select2({theme:"bootstrap-5",dropdownParent:$("#addProgramaModal"),placeholder:"Seleccionar orador final...",allowClear:!0,width:"100%"}),$("#add_cancion_pre").select2({theme:"bootstrap-5",dropdownParent:$("#addProgramaModal"),placeholder:"Seleccionar canción inicial...",allowClear:!0,width:"100%"}),$("#add_cancion_en").select2({theme:"bootstrap-5",dropdownParent:$("#addProgramaModal"),placeholder:"Seleccionar canción intermedia...",allowClear:!0,width:"100%"}),$("#add_cancion_post").select2({theme:"bootstrap-5",dropdownParent:$("#addProgramaModal"),placeholder:"Seleccionar canción final...",allowClear:!0,width:"100%"})}window.programasTable=n,function(){if(!$("#filtro_anio").length)return void console.error("Elemento #filtro_anio no encontrado");if(!$("#mesDropdownBtn").length)return void console.error("Elemento #mesDropdownBtn no encontrado");$('meta[name="csrf-token"]').attr("content"),$("#filtro_anio").select2({theme:"bootstrap-5",placeholder:"Seleccionar año",allowClear:!0,width:"120px"}),function(){const e=$('meta[name="csrf-token"]').attr("content");if(!e)return console.error("CSRF token not found"),void a("Error de configuración: Token CSRF no encontrado","danger");$.ajax({url:"/programas/anios-disponibles",method:"GET",headers:{"X-CSRF-TOKEN":e},success:function(e){if(e&&e.success){const a=$("#filtro_anio");a.find('option:not([value=""])').remove(),e.anios&&Array.isArray(e.anios)&&(e.anios.forEach(function(e){a.append(`<option value="${e}">${e}</option>`)}),window.anioMasReciente&&a.val(window.anioMasReciente).trigger("change"))}else{a("Error al cargar años disponibles: "+(e&&e.message?e.message:"Respuesta inválida del servidor"),"danger")}},error:function(e,o,n){let r="Error al conectar con el servidor";if(404===e.status)r="Ruta no encontrada";else if(500===e.status)r="Error interno del servidor";else if(e.responseText)try{r=JSON.parse(e.responseText).message||r}catch(t){r="Error desconocido del servidor"}a(r,"danger")}})}(),$("#filtro_anio").on("change",function(){const e=$(this).val();e?($("#mesDropdownBtn").prop("disabled",!1),function(e){const n=$('meta[name="csrf-token"]').attr("content");if(!n)return console.error("CSRF token not found"),void a("Error de configuración: Token CSRF no encontrado","danger");$.ajax({url:`/programas/meses-disponibles/${e}`,method:"GET",headers:{"X-CSRF-TOKEN":n},success:function(e){if(e&&e.success){const a=$("#mesDropdownMenu"),n='\n                    <li><hr class="dropdown-divider"></li>\n                    <li class="px-2">\n                        <button type="button" class="btn btn-sm btn-outline-secondary w-100" id="seleccionarTodosMeses">Seleccionar Todos</button>\n                    </li>\n                    <li class="px-2 mt-2">\n                        <button type="button" class="btn btn-sm btn-outline-secondary w-100" id="limpiarMeses">Limpiar Selección</button>\n                    </li>\n                ';a.html(n),e.meses&&Array.isArray(e.meses)&&e.meses.forEach(function(e){const o=`\n                            <li class="px-2">\n                                <div class="form-check">\n                                    <input class="form-check-input mes-checkbox" type="checkbox" value="${e.numero_mes}" id="mes_${e.numero_mes}">\n                                    <label class="form-check-label" for="mes_${e.numero_mes}">\n                                        ${e.nombre}\n                                    </label>\n                                </div>\n                            </li>\n                        `,n=a.find("button").first();n.length>0?n.closest("li").before(o):a.append(o)}),o(),window.actualizarBotonesExportacion&&window.actualizarBotonesExportacion()}else{a("Error al cargar meses disponibles: "+(e&&e.message?e.message:"Respuesta inválida del servidor"),"danger")}},error:function(e,o,n){let r="Error al conectar con el servidor";if(404===e.status)r="Ruta no encontrada";else if(500===e.status)r="Error interno del servidor";else if(e.responseText)try{r=JSON.parse(e.responseText).message||r}catch(t){r="Error desconocido del servidor"}a(r,"danger")}})}(e),setTimeout(function(){!function(e){const o=$('meta[name="csrf-token"]').attr("content");if(!o)return console.error("CSRF token not found"),void a("Error de configuración: Token CSRF no encontrado","danger");const n=$("#btnBuscarProgramas"),r=n.html();n.prop("disabled",!0).html('<i class="fas fa-spinner fa-spin"></i>'),$.ajax({url:"/programas/buscar-por-anio",method:"GET",headers:{"X-CSRF-TOKEN":o},data:{anio:e},success:function(o){if(o&&o.success&&o.programas){let n=window.programasTable;if(!n&&$.fn.DataTable.isDataTable("#programasTable")&&(n=$("#programasTable").DataTable()),n){if(n.clear(),0===o.programas.length)return a(`No se encontraron programas para el año ${e}.`,"info"),void n.draw();const r=new Date,t=r.getDay(),s=0===t?-6:1-t,i=0===t?0:7-t,d=new Date(r);d.setDate(r.getDate()+s),d.setHours(0,0,0,0);const l=new Date(r);if(l.setDate(r.getDate()+i),l.setHours(23,59,59,999),o.programas.forEach(function(e){const a=e.fecha.split("-"),o=`${a[2]}/${a[1]}/${a[0]}`,r=new Date(parseInt(a[0]),parseInt(a[1])-1,parseInt(a[2]));r.setHours(0,0,0,0);const t=r>=d&&r<=l;let s=`\n                            <div class="btn-group" role="group">\n                                <a href="/programas/${e.id}" class="btn btn-sm btn-info" data-bs-toggle="tooltip" title="Ver programa">\n                                    <i class="fas fa-eye"></i>\n                                </a>`;void 0!==window.isCoordinatorOrOrganizer&&window.isCoordinatorOrOrganizer&&(s+=`\n                                <a href="/programas/${e.id}/edit" class="btn btn-sm btn-warning" data-bs-toggle="tooltip" title="Editar programa">\n                                    <i class="fas fa-edit"></i>\n                                </a>\n                                <button type="button" class="btn btn-sm btn-danger delete-programa" \n                                        data-id="${e.id}"\n                                        data-bs-toggle="modal"\n                                        data-bs-target="#confirmDeleteModal"\n                                        title="Eliminar programa">\n                                    <i class="fas fa-trash"></i>\n                                </button>`),s+="</div>",n.row.add($(`\n                            <tr class="${t?"semana-actual-row":""}">\n                                <td data-order="${e.fecha}">${o}</td>\n                                <td>${e.nombre_presidencia||"-"}</td>\n                                <td>${e.nombre_orador_inicial||"-"}</td>\n                                <td>${null!=e.numero_cancion_pre?e.numero_cancion_pre:"-"}</td>\n                                <td>${null!=e.numero_cancion_en?e.numero_cancion_en:"-"}</td>\n                                <td>${null!=e.numero_cancion_post?e.numero_cancion_post:"-"}</td>\n                                <td>${e.nombre_orador_final||"-"}</td>\n                                <td>${s}</td>\n                            </tr>\n                        `)[0])}),n.draw(),"undefined"!=typeof bootstrap&&bootstrap.Tooltip){[].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]')).map(function(e){return new bootstrap.Tooltip(e)})}$(".delete-programa").off("click").on("click",function(){window.programaIdToDelete=$(this).data("id")})}else a("Error: No se pudo acceder a la tabla de programas.","danger")}else{a("Error al buscar programas: "+(o&&o.message?o.message:"Respuesta inválida del servidor"),"danger")}},error:function(e,o,n){let r="Error al conectar con el servidor";403===e.status?r="No tienes permiso para realizar esta acción":404===e.status?r="Ruta no encontrada":500===e.status?r="Error interno del servidor":e.responseJSON&&e.responseJSON.message&&(r=e.responseJSON.message),a(r,"danger")},complete:function(){n.prop("disabled",!1).html(r)}})}(e)},100)):($("#mesDropdownBtn").prop("disabled",!0),$('#mesDropdownMenu input[type="checkbox"]').prop("checked",!1),o(),window.actualizarBotonesExportacion&&window.actualizarBotonesExportacion()),window.actualizarBotonesExportacion&&window.actualizarBotonesExportacion()}),$(document).on("change",'#mesDropdownMenu input[type="checkbox"]',function(){o(),e(),window.actualizarBotonesExportacion&&window.actualizarBotonesExportacion()}),$(document).on("click","#seleccionarTodosMeses",function(a){a.stopPropagation(),$('#mesDropdownMenu input[type="checkbox"]').prop("checked",!0),o(),e(),window.actualizarBotonesExportacion&&window.actualizarBotonesExportacion()}),$(document).on("click","#limpiarMeses",function(a){a.stopPropagation(),$('#mesDropdownMenu input[type="checkbox"]').prop("checked",!1),o(),e(),window.actualizarBotonesExportacion&&window.actualizarBotonesExportacion()})}(),window.initializeSelect2ForCoordinators=r,r(),$("#addProgramaForm").submit(function(e){e.preventDefault();const a=$("#addProgramaBtn"),o=a.find(".spinner-border");a.prop("disabled",!0),o.removeClass("d-none"),$(".is-invalid").removeClass("is-invalid"),$(".invalid-feedback").text(""),$("#add-alert-container").empty(),$.ajax({url:"/programas",method:"POST",headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},data:$(this).serialize(),success:function(e){e.success?($("#addProgramaModal").modal("hide"),location.reload()):s("add-alert-container","danger",e.message||"Error al crear el programa")},error:function(e){if(422===e.status){const a=e.responseJSON.errors;for(const e in a)$(`#add_${e}`).addClass("is-invalid"),$(`#add_${e}`).siblings(".invalid-feedback").text(a[e][0])}else 419===e.status?s("add-alert-container","danger","Sesión expirada. Por favor, recarga la página e intenta nuevamente."):s("add-alert-container","danger","Error al crear el programa")},complete:function(){a.prop("disabled",!1),o.addClass("d-none")}})}),$(".edit-programa").click(function(){const e=$(this).data("id"),a=$(this).closest("tr").find("td:eq(0)").text().trim().split("/").reverse().join("-");$("#edit_programa_id").val(e),$("#edit_fecha").val(a),$("#edit_estado").val("1")}),$("#editProgramaForm").submit(function(e){e.preventDefault();const a=$("#edit_programa_id").val(),o=$("#editProgramaBtn"),n=o.find(".spinner-border");o.prop("disabled",!0),n.removeClass("d-none"),$(".is-invalid").removeClass("is-invalid"),$(".invalid-feedback").text(""),$("#edit-alert-container").empty(),$.ajax({url:`/programas/${a}`,method:"PUT",data:$(this).serialize(),success:function(e){e.success?($("#editProgramaModal").modal("hide"),location.reload()):s("edit-alert-container","danger",e.message||"Error al actualizar el programa")},error:function(e){if(422===e.status){const a=e.responseJSON.errors;for(const e in a)$(`#edit_${e}`).addClass("is-invalid"),$(`#edit_${e}`).siblings(".invalid-feedback").text(a[e][0])}else s("edit-alert-container","danger","Error al actualizar el programa")},complete:function(){o.prop("disabled",!1),n.addClass("d-none")}})});let t=null;function s(e,a,o){const n=`\n            <div class="alert alert-${a} alert-dismissible fade show" role="alert">\n                ${o}\n                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>\n            </div>\n        `;$(`#${e}`).html(n)}function i(){const e=$("#filtro_anio").val(),a=$('#mesDropdownMenu input[type="checkbox"]:checked').map(function(){return $(this).val()}).get(),o=$("#exportPdfBtn"),n=$("#exportProgramaXlsBtn"),r=$("#exportXlsBtn"),t=$("#exportResumenVistaBtn"),s=$("#exportAsignacionesBtn");if(e&&a.length>0){o.removeClass("disabled").prop("disabled",!1),n.removeClass("disabled").prop("disabled",!1),r.removeClass("disabled").prop("disabled",!1),t.removeClass("disabled").prop("disabled",!1),s.removeClass("disabled").prop("disabled",!1);let i="?anio="+e;a.forEach(function(e){i+="&mes[]="+e}),o.data("export-url",window.exportRoutes.pdf+i),n.data("export-url",window.exportRoutes.programaXls+i),r.data("export-url",window.exportRoutes.xls+i),t.data("export-url",window.exportRoutes.resumenVista+i),s.data("export-url",window.exportRoutes.asignaciones+i)}else o.addClass("disabled").prop("disabled",!0),n.addClass("disabled").prop("disabled",!0),r.addClass("disabled").prop("disabled",!0),t.addClass("disabled").prop("disabled",!0),s.addClass("disabled").prop("disabled",!0),o.removeData("export-url"),n.removeData("export-url"),r.removeData("export-url"),t.removeData("export-url"),s.removeData("export-url")}$(".delete-programa").click(function(){t=$(this).data("id")}),$("#confirmDeleteBtn").click(function(){t&&$.ajax({url:`/programas/${t}`,method:"DELETE",headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},data:{_token:$('meta[name="csrf-token"]').attr("content")},success:function(e){e.success?($("#confirmDeleteModal").modal("hide"),location.reload()):(s("alert-container","danger",e.message||"Error al eliminar el programa"),$("#confirmDeleteModal").modal("hide"))},error:function(e){let a="Error al eliminar el programa";419===e.status?a="Sesión expirada. Por favor, recarga la página e intenta nuevamente.":e.responseJSON&&e.responseJSON.message&&(a=e.responseJSON.message),s("alert-container","danger",a),$("#confirmDeleteModal").modal("hide")}})}),$("#confirmDeleteModal").on("hidden.bs.modal",function(){t=null}),$("#confirmDeleteModal").on("show.bs.modal",function(){t=null}),window.handleModalEventsForSelect2=function(){$("#addProgramaModal").on("shown.bs.modal",function(){$("#add_presidencia").hasClass("select2-hidden-accessible")||$("#add_presidencia").select2({theme:"bootstrap-5",dropdownParent:$("#addProgramaModal"),placeholder:"Seleccionar presidencia...",allowClear:!0,width:"100%"}),$("#add_orador_inicial").hasClass("select2-hidden-accessible")||$("#add_orador_inicial").select2({theme:"bootstrap-5",dropdownParent:$("#addProgramaModal"),placeholder:"Seleccionar orador inicial...",allowClear:!0,width:"100%"}),$("#add_orador_final").hasClass("select2-hidden-accessible")||$("#add_orador_final").select2({theme:"bootstrap-5",dropdownParent:$("#addProgramaModal"),placeholder:"Seleccionar orador final...",allowClear:!0,width:"100%"}),$("#add_cancion_pre").hasClass("select2-hidden-accessible")||$("#add_cancion_pre").select2({theme:"bootstrap-5",dropdownParent:$("#addProgramaModal"),placeholder:"Seleccionar canción inicial...",allowClear:!0,width:"100%"}),$("#add_cancion_en").hasClass("select2-hidden-accessible")||$("#add_cancion_en").select2({theme:"bootstrap-5",dropdownParent:$("#addProgramaModal"),placeholder:"Seleccionar canción intermedia...",allowClear:!0,width:"100%"}),$("#add_cancion_post").hasClass("select2-hidden-accessible")||$("#add_cancion_post").select2({theme:"bootstrap-5",dropdownParent:$("#addProgramaModal"),placeholder:"Seleccionar canción final...",allowClear:!0,width:"100%"})}),$("#addProgramaModal").on("hidden.bs.modal",function(){$("#add_presidencia").hasClass("select2-hidden-accessible")&&$("#add_presidencia").select2("destroy"),$("#add_orador_inicial").hasClass("select2-hidden-accessible")&&$("#add_orador_inicial").select2("destroy"),$("#add_orador_final").hasClass("select2-hidden-accessible")&&$("#add_orador_final").select2("destroy"),$("#add_cancion_pre").hasClass("select2-hidden-accessible")&&$("#add_cancion_pre").select2("destroy"),$("#add_cancion_en").hasClass("select2-hidden-accessible")&&$("#add_cancion_en").select2("destroy"),$("#add_cancion_post").hasClass("select2-hidden-accessible")&&$("#add_cancion_post").select2("destroy"),$("#addProgramaForm")[0].reset()})},handleModalEventsForSelect2(),window.actualizarBotonesExportacion=i,$("#exportPdfBtn, #exportProgramaXlsBtn, #exportXlsBtn, #exportResumenVistaBtn, #exportAsignacionesBtn").on("click",function(e){e.preventDefault();const a=$(this).data("export-url");a&&!$(this).prop("disabled")&&window.open(a,"_blank")}),$("#filtro_anio").on("change",function(){i()}),$(document).on("change",'#mesDropdownMenu input[type="checkbox"]',function(){i()}),i()});
