$(document).ready(function(){var e=$("#gruposTable").DataTable({responsive:!0,processing:!0,serverSide:!1,ajax:{url:window.gruposIndexConfig.dataRoute,dataSrc:"data"},columns:[{data:"id",width:"5%"},{data:"nombre",width:"25%"},{data:"congregacion",width:"20%",render:function(e,a,n){return`<span class="badge bg-primary">${e}</span>`}},{data:"estado",width:"15%",render:function(e,a,n){return 1==e?'<span class="badge bg-success">Habilitado</span>':'<span class="badge bg-danger">Deshabilitado</span>'}},{data:"usuarios_count",width:"15%",render:function(e,a,n){return`<span class="badge bg-info">${e}</span>`}},{data:null,width:"20%",orderable:!1,render:function(e,a,n){let o=`\n                        <div class="btn-group" role="group">\n                            <button type="button" class="btn btn-sm btn-info view-grupo"\n                                    data-grupo-id="${n.id}"\n                                    data-bs-toggle="tooltip"\n                                    title="Ver grupo">\n                                <i class="fas fa-eye"></i>\n                            </button>`;return window.gruposIndexConfig.canModify&&(o+=`\n                            <button type="button" class="btn btn-sm btn-warning edit-grupo"\n                                    data-grupo-id="${n.id}"\n                                    data-bs-toggle="tooltip"\n                                    title="Editar grupo">\n                                <i class="fas fa-edit"></i>\n                            </button>`),o+="</div>",o}}],language:{url:"/js/datatables-es-ES.json"},order:[[1,"asc"]],drawCallback:function(){$('[data-bs-toggle="tooltip"]').tooltip()}});let a=null;function n(e,a){const n=`\n            <div class="alert alert-${e} alert-dismissible fade show" role="alert">\n                ${a}\n                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>\n            </div>\n        `;$("#alert-container").html(n),"success"===e&&setTimeout(()=>{$(".alert").alert("close")},5e3)}function o(){$(".form-control, .form-select").removeClass("is-invalid"),$(".invalid-feedback").text("")}function t(e){o(),$.each(e,function(e,a){const n=$(`[name="${e}"]`);n.addClass("is-invalid"),n.siblings(".invalid-feedback").text(a[0])})}$("#estadoFilter").on("change",function(){const n=$(this).val();if(null!==a&&$.fn.dataTable.ext.search.splice($.fn.dataTable.ext.search.indexOf(a),1),""===n)a=null,e.draw();else{const o="1"===n?"Habilitado":"Deshabilitado";a=function(a,n,t){if(a.nTable!==e.table().node())return!0;return-1!==n[3].indexOf(o)},$.fn.dataTable.ext.search.push(a),e.draw()}}),$('[data-bs-toggle="tooltip"]').tooltip(),$("#addGrupoForm").on("submit",function(a){a.preventDefault();const s=$(this),r=$("#saveGrupoBtn"),i=r.find(".spinner-border");r.prop("disabled",!0),i.removeClass("d-none"),o(),$.ajax({url:window.gruposIndexConfig.storeRoute,method:"POST",data:s.serialize(),success:function(a){a.success&&(n("success",a.message),$("#addGrupoModal").modal("hide"),s[0].reset(),e.ajax.reload(null,!1))},error:function(e){const a=e.responseJSON;if(422===e.status&&a.errors)t(a.errors);else{n("danger",a.message||"Error al crear el grupo. Intente nuevamente.")}},complete:function(){r.prop("disabled",!1),i.addClass("d-none")}})}),$(document).on("click",".view-grupo",function(){const e=$(this).data("grupo-id");$.ajax({url:`/grupos/${e}`,method:"GET",success:function(e){if(e.success){const a=e.grupo;$("#view_grupo_nombre").text(a.nombre),$("#view_grupo_congregacion").text(a.congregacion?a.congregacion.nombre:"Sin asignar"),$("#view_grupo_estado").html(1==a.estado?'<span class="badge bg-success">Habilitado</span>':'<span class="badge bg-danger">Deshabilitado</span>'),$("#view_grupo_usuarios").text(a.usuarios_count),$("#viewGrupoModal").modal("show")}},error:function(){n("danger","Error al cargar los datos del grupo.")}})}),$(document).on("click",".edit-grupo",function(){const e=$(this).data("grupo-id");$.ajax({url:`/grupos/${e}`,method:"GET",success:function(e){if(e.success){const a=e.grupo;$("#edit_grupo_id").val(a.id),$("#edit_nombre").val(a.nombre),$("#edit_congregacion_id").val(a.congregacion_id),$("#edit_estado").val(a.estado),$("#editGrupoModal").modal("show")}},error:function(){n("danger","Error al cargar los datos del grupo.")}})}),$("#editGrupoForm").on("submit",function(a){a.preventDefault();const s=$(this),r=$("#edit_grupo_id").val(),i=$("#updateGrupoBtn"),d=i.find(".spinner-border");i.prop("disabled",!0),d.removeClass("d-none"),o(),$.ajax({url:`/grupos/${r}`,method:"PUT",data:s.serialize(),success:function(a){a.success&&(n("success",a.message),$("#editGrupoModal").modal("hide"),e.ajax.reload(null,!1))},error:function(e){const a=e.responseJSON;if(422===e.status&&a.errors)t(a.errors);else{n("danger",a.message||"Error al actualizar el grupo. Intente nuevamente.")}},complete:function(){i.prop("disabled",!1),d.addClass("d-none")}})}),$(".modal").on("hidden.bs.modal",function(){o(),$(this).find("form")[0].reset(),$(this).find(".spinner-border").addClass("d-none"),$(this).find('button[type="submit"]').prop("disabled",!1)})});
